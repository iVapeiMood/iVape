<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>iVape Runner 3.0</title>
<style>
body { margin:0; overflow:hidden; font-family:Arial,sans-serif; background:#000; }
canvas { display:block; }
#nameInputUI, #gameOverUI { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:white; z-index:100; }
#nameInput { padding:10px; font-size:18px; }
button { padding:10px 20px; font-size:18px; margin-top:10px; cursor:pointer; border:none; border-radius:10px; background:#222; color:white; }
#leaderboard { position:absolute; top:10px; left:10px; color:white; background:rgba(0,0,0,0.5); padding:10px; border-radius:10px; max-width:200px; z-index:50; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="nameInputUI">
  <div>Введите имя:</div>
  <input type="text" id="nameInput" placeholder="Ваше имя"><br>
  <button id="submitName">Старт</button>
</div>

<div id="gameOverUI" style="display:none;">
  <div>Хотите повторить попытку?</div>
  <button id="retryBtn">Да</button>
</div>

<div id="leaderboard"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, push, get, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

// ================= Firebase =================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ================= Игровые переменные =================
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const retryBtn=document.getElementById('retryBtn');
const gameOverUI=document.getElementById('gameOverUI');
const leaderboardDiv=document.getElementById('leaderboard');
let playerName="";
let playerId = localStorage.getItem("playerId") || crypto.randomUUID();
localStorage.setItem("playerId", playerId);

function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
resizeCanvas(); window.addEventListener('resize',resizeCanvas);

// Игрок
let player={width:60,height:60,x:100,y:0,vy:0,gravity:0.6,jump:-15,
crouching:false,runFrames:[],frameIndex:0,frameSpeed:5,imgJump:new Image(),imgCrouch:new Image(),effectTimer:0};
for(let i=1;i<=2;i++){let img=new Image(); img.src="assets/images/player_run"+i+".png"; player.runFrames.push(img);}
player.imgJump.src="assets/images/player_jump.png";
player.imgCrouch.src="assets/images/player_crouch.png";

// Объекты
let obstacles=[], obstacleImages={ground:new Image(), air:new Image()};
obstacleImages.ground.src="assets/images/obstacle1.png";
obstacleImages.air.src="assets/images/obstacle2.png";

let bonuses=[], slows=[];
let bonusImg=new Image(); bonusImg.src="assets/images/bonus.png";
let slowImg=new Image(); slowImg.src="assets/images/slow.png";

let bgImg=new Image(); bgImg.src="assets/images/background.png";
let grassImg=new Image(); grassImg.src="assets/images/grass.png";

let groundY=0,bgX=0;
let speedMultiplier=1,invertedControl=false;
let frame=0,score=0,gameOver=false,gameRunning=false;

// ====================== Загрузка всех текстур ======================
let assetsLoaded=0;
let totalAssets=10;
function assetLoaded(){ assetsLoaded++; if(assetsLoaded>=totalAssets){ restartGame(); } }

player.imgJump.onload = assetLoaded;
player.imgCrouch.onload = assetLoaded;
player.runFrames.forEach(img=>img.onload=assetLoaded);
bgImg.onload = assetLoaded;
grassImg.onload = assetLoaded;
obstacleImages.ground.onload = assetLoaded;
obstacleImages.air.onload = assetLoaded;
bonusImg.onload = assetLoaded;
slowImg.onload = assetLoaded;

// ====================== Сброс игры ======================
function restartGame(){
  groundY = canvas.height*0.7;
  player.y = groundY-player.height; player.vy=0; player.crouching=false; player.effectTimer=0;
  obstacles=[]; bonuses=[]; slows=[];
  frame=0; score=0; gameOver=false;
  speedMultiplier=1; invertedControl=false;
  gameOverUI.style.display="none"; update();
  gameRunning=true;
}

// ====================== Рекорды ======================
async function sendScore(name, id, score){
  await push(ref(db,'scores'),{name,id,score});
  updateLeaderboard();
}

async function updateLeaderboard(){
  const q = query(ref(db,'scores'), orderByChild('score'), limitToLast(10));
  const snapshot = await get(q);
  let data = snapshot.val();
  if(!data) return;
  let arr = Object.values(data).sort((a,b)=>b.score-a.score);
  leaderboardDiv.innerHTML = "<b>Топ игроков:</b><br>"+arr.map(x=>x.name+": "+x.score).join("<br>");
}

// ====================== Генерация объектов ======================
function spawnObject(type){
  let obj = {x: canvas.width, width:50, height:50};
  if(type==="bonus"||type==="slow") obj.y = groundY - obj.height - 5;
  else if(type==="air") obj.y = groundY - obj.height - 150;
  else obj.y = groundY - obj.height;
  if(type==="bonus") bonuses.push(obj);
  else if(type==="slow") slows.push(obj);
  else obstacles.push(obj);
}

// ====================== Основной цикл ======================
function update(){
  if(gameOver){ gameRunning=false; gameOverUI.style.display="block"; return; }
  frame++; ctx.clearRect(0,0,canvas.width,canvas.height);

  // Фон
  if(bgImg.complete) ctx.drawImage(bgImg,bgX,0,canvas.width,canvas.height*0.7);
  bgX-=1*speedMultiplier; if(bgX<=-canvas.width) bgX=0;
  if(bgImg.complete) ctx.drawImage(bgImg,bgX+canvas.width,0,canvas.width,canvas.height*0.7);

  // Земля
  if(grassImg.complete) ctx.drawImage(grassImg,0,groundY,canvas.width,canvas.height-groundY);

  // Создание объектов
  if(frame%100===0) spawnObject("ground");
  if(frame%500===0) spawnObject("bonus");
  if(frame%1000===0) spawnObject("slow");
  if(frame%700===0) spawnObject("air");

  // Препятствия
  for(let i=obstacles.length-1;i>=0;i--){
    let o=obstacles[i]; o.x-=4*speedMultiplier;
    if(o.x+o.width<0){ obstacles.splice(i,1); score++; continue; }
    if(obstacleImages.ground.complete && o.y>=groundY-50) ctx.drawImage(obstacleImages.ground,o.x,o.y,o.width,o.height);
    else if(obstacleImages.air.complete && o.y<groundY-50) ctx.drawImage(obstacleImages.air,o.x,o.y,o.width,o.height);
    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<o.x+o.width-pad && player.x+player.width-pad>o.x+pad &&
       player.y+pad<o.y+o.height-pad && playerBottom-pad>o.y+pad){
      gameOver=true; sendScore(playerName,playerId,score);
    }
  }

  // Бонусы
  bonuses.forEach((b,i)=>{
    b.x-=4*speedMultiplier;
    if(b.x+b.width<0){ bonuses.splice(i,1); return; }
    if(bonusImg.complete) ctx.drawImage(bonusImg,b.x,b.y,b.width,b.height);
    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<b.x+b.width-pad && player.x+player.width-pad>b.x+pad &&
       player.y+pad<b.y+b.height-pad && playerBottom-pad>b.y+pad){
      score+=5; speedMultiplier=1.5; player.effectTimer=30; bonuses.splice(i,1);
      setTimeout(()=>speedMultiplier=1,5000);
    }
  });

  // Отрицательные бонусы
  slows.forEach((s,i)=>{
    s.x-=4*speedMultiplier;
    if(s.x+s.width<0){ slows.splice(i,1); return; }
    if(slowImg.complete) ctx.drawImage(slowImg,s.x,s.y,s.width,s.height);
    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<s.x+s.width-pad && player.x+player.width-pad>s.x+pad &&
       player.y+pad<s.y+s.height-pad && playerBottom-pad>s.y+pad){
      score=Math.max(0,score-10); invertedControl=true; player.effectTimer=30; slows.splice(i,1);
      setTimeout(()=>invertedControl=false,5000);
    }
  });

  // Игрок
  player.vy+=player.gravity; player.y+=player.vy;
  if(player.y>groundY-player.height){ player.y=groundY-player.height; player.vy=0; }
  let actualY=player.y; let drawHeight=player.height;
  if(player.crouching){ drawHeight=player.height/2; actualY+=player.height/2; }
  let imgToDraw;
  if(player.y<groundY-player.height) imgToDraw=player.imgJump;
  else if(player.crouching) imgToDraw=player.imgCrouch;
  else { if(frame%player.frameSpeed===0) player.frameIndex=(player.frameIndex+1)%player.runFrames.length;
         imgToDraw=player.runFrames[player.frameIndex]; }
  if(player.effectTimer>0){ if(Math.floor(frame/5)%2==0) ctx.globalAlpha=0.5; }
  if(imgToDraw.complete) ctx.drawImage(imgToDraw,player.x,actualY,player.width,drawHeight);
  ctx.globalAlpha=1;
  if(player.effectTimer>0) player.effectTimer--;

  // Счёт
  ctx.fillStyle="rgba(0,0,0,0.5)"; ctx.fillRect(canvas.width-160,10,150,40);
  ctx.fillStyle="white"; ctx.font="bold 24px Arial"; ctx.fillText("Score: "+score,canvas.width-150,40);

  requestAnimationFrame(update);
}

// ====================== Управление ======================
function jump(){ if(!gameOver && player.y>=groundY-player.height-1) player.vy=player.jump; }
function crouchStart(){ if(!gameOver) player.crouching=true; }
function crouchEnd(){ player.crouching=false; }

document.addEventListener('keydown', e=>{
  if(invertedControl){ if(e.code==='Space'||e.code==='ArrowDown') jump(); if(e.code==='ArrowUp') crouchStart(); }
  else { if(e.code==='Space'||e.code==='ArrowUp') jump(); if(e.code==='ArrowDown') crouchStart(); }
});
document.addEventListener('keyup', e=>{ if(e.code==='ArrowDown'||e.code==='ArrowUp') crouchEnd(); });
document.addEventListener('click', jump);

// Сенсор
let touchStartY=null;
document.addEventListener('touchstart', e=>{ touchStartY=e.touches[0]?.clientY; });
document.addEventListener('touchend', e=>{
  if(!touchStartY) return; let touchEndY=e.changedTouches[0]?.clientY; if(!touchEndY) return;
  let delta=touchStartY-touchEndY;
  if(!invertedControl){ if(delta>30) jump(); else if(delta<-30) crouchStart(); }
  else { if(delta>30) crouchStart(); else if(delta<-30) jump(); }
  setTimeout(crouchEnd,200); touchStartY=null;
});

// ====================== Кнопки ======================
retryBtn.addEventListener('click',()=>{ restartGame(); });
document.getElementById('submitName').addEventListener('click',()=>{
  let input=document.getElementById('nameInput').value.trim();
  if(input){ playerName=input; document.getElementById('nameInputUI').style.display="none"; restartGame(); updateLeaderboard(); }
});
</script>
</body>
</html>
