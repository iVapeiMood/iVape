<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>iVape Runner Fullscreen</title>
<style>
body { margin:0; overflow:hidden; }
canvas { display:block; background:#87CEEB; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');

function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

// ======================
// Игрок
// ======================
let player={
  width:60,height:60,x:100,y:0,
  vy:0,gravity:0.6,jump:-15,
  crouching:false,runFrames:[],frameIndex:0,frameSpeed:5,
  imgJump:new Image(),imgCrouch:new Image(),
  effectTimer:0 // для визуального эффекта при сборе предмета
};

for(let i=1;i<=2;i++){ let img=new Image(); img.src="assets/images/player_run"+i+".png"; player.runFrames.push(img);}
player.imgJump.src="assets/images/player_jump.png";
player.imgCrouch.src="assets/images/player_crouch.png";

// ======================
// Препятствия
// ======================
let obstacles=[];
let frame=0,score=0,gameOver=false,gameRunning=false;
let groundY=0,bgX=0,grassX=0;
let speedMultiplier=1,invertedControl=false;

// ======================
// Бонусы и замедление
// ======================
let bonuses=[],slows=[];

// ======================
// Создание объектов
// ======================
function createObstacle(){
  let o={x:canvas.width,width:60,height:60};
  o.type=Math.random()<0.7?"ground":"air";
  o.y=(o.type==="ground")?groundY-o.height:groundY-o.height-80;
  obstacles.push(o);
}

function createBonus(){ bonuses.push({x:canvas.width,y:groundY-50,width:50,height:50}); }
function createSlow(){ slows.push({x:canvas.width,y:groundY-50,width:50,height:50}); }

// ======================
// Сброс игры
// ======================
function restartGame(){
  groundY=canvas.height-80;
  player.y=groundY-player.height;
  player.vy=0;
  player.crouching=false;
  player.effectTimer=0;
  obstacles=[]; bonuses=[]; slows=[];
  frame=0; score=0; gameOver=false;
  speedMultiplier=1; invertedControl=false;
  if(!gameRunning) update();
  gameRunning=true;
}

// ======================
// Основной цикл
// ======================
function update(){
  if(gameOver){ gameRunning=false; return; }
  frame++; ctx.clearRect(0,0,canvas.width,canvas.height);

  // ---------- Фон ----------
  ctx.fillStyle="linear-gradient(to bottom, #ff9e9e, #870000)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // ---------- Земля ----------
  groundY=canvas.height-80;
  ctx.fillStyle="#228B22";
  ctx.fillRect(0,groundY,canvas.width,80);

  // ---------- Создание объектов ----------
  if(frame%100===0) createObstacle();
  if(frame%500===0) createBonus();
  if(frame%1000===0) createSlow();

  // ---------- Препятствия ----------
  for(let i=obstacles.length-1;i>=0;i--){
    let o=obstacles[i]; o.x-=4*speedMultiplier;
    if(o.x+o.width<0){ obstacles.splice(i,1); score++; continue; }
    ctx.fillStyle="brown";
    ctx.fillRect(o.x,o.y,o.width,o.height);

    let pad=5;
    let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<o.x+o.width-pad &&
       player.x+player.width-pad>o.x+pad &&
       player.y+pad<o.y+o.height-pad &&
       playerBottom-pad>o.y+pad){
      gameOver=true;
      setTimeout(()=>{if(confirm("Game Over! Score: "+score+"\nRestart?")) restartGame();},10);
    }
  }

  // ---------- Бонусы (зелёные мерцают) ----------
  for(let i=bonuses.length-1;i>=0;i--){
    let b=bonuses[i]; b.x-=4*speedMultiplier;
    if(b.x+b.width<0){ bonuses.splice(i,1); continue; }
    ctx.fillStyle = frame%20<10?"#00FF00":"#00AA00";
    ctx.fillRect(b.x,b.y,b.width,b.height);

    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<b.x+b.width-pad &&
       player.x+player.width-pad>b.x+pad &&
       player.y+pad<b.y+b.height-pad &&
       playerBottom-pad>b.y+pad){
      bonuses.splice(i,1);
      score+=5;
      speedMultiplier=1.5;
      player.effectTimer=30; // подсветка игрока
      setTimeout(()=>speedMultiplier=1,5000);
    }
  }

  // ---------- Замедление (красные мерцают) ----------
  for(let i=slows.length-1;i>=0;i--){
    let s=slows[i]; s.x-=4*speedMultiplier;
    if(s.x+s.width<0){ slows.splice(i,1); continue; }
    ctx.fillStyle = frame%20<10?"#FF0000":"#AA0000";
    ctx.fillRect(s.x,s.y,s.width,s.height);

    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<s.x+s.width-pad &&
       player.x+player.width-pad>s.x+pad &&
       player.y+pad<s.y+s.height-pad &&
       playerBottom-pad>s.y+pad){
      slows.splice(i,1);
      speedMultiplier=0.5;
      invertedControl=true;
      player.effectTimer=30;
      setTimeout(()=>{speedMultiplier=1; invertedControl=false;},5000);
    }
  }

  // ---------- Игрок ----------
  player.vy+=player.gravity;
  player.y+=player.vy;
  if(player.y>groundY-player.height){player.y=groundY-player.height; player.vy=0;}
  let actualY=player.y;
  let drawHeight=player.height;
  if(player.crouching){drawHeight=player.height/2; actualY+=player.height/2;}

  // Подсветка при эффекте
  if(player.effectTimer>0){
    ctx.fillStyle="yellow";
    player.effectTimer--;
  } else {
    ctx.fillStyle="blue";
  }
  ctx.fillRect(player.x,actualY,player.width,drawHeight);

  // ---------- Счёт ----------
  ctx.fillStyle="black"; ctx.font="20px Arial";
  ctx.fillText("Score: "+score,canvas.width-150,30);

  requestAnimationFrame(update);
}

// ======================
// Управление
// ======================
function jump(){ if(!gameOver && player.y>=groundY-player.height-1) player.vy=player.jump; }
function crouchStart(){ if(!gameOver) player.crouching=true; }
function crouchEnd(){ player.crouching=false; }

// Клавиатура
document.addEventListener('keydown',e=>{
  if(invertedControl){ if(e.code==='Space'||e.code==='ArrowDown') jump(); if(e.code==='ArrowUp') crouchStart(); }
  else{ if(e.code==='Space'||e.code==='ArrowUp') jump(); if(e.code==='ArrowDown') crouchStart(); }
});
document.addEventListener('keyup',e=>{ if(e.code==='ArrowDown'||e.code==='ArrowUp') crouchEnd(); });
document.addEventListener('click', jump);

// Сенсор
let touchStartY=null;
document.addEventListener('touchstart', e=>{ touchStartY=e.touches[0]?.clientY; });
document.addEventListener('touchend', e=>{
  if(!touchStartY) return;
  let touchEndY=e.changedTouches[0]?.clientY;
  if(!touchEndY) return;
  let delta=touchStartY-touchEndY;
  if(!invertedControl){
    if(delta>30) jump();
    else if(delta<-30) crouchStart();
  } else {
    if(delta>30) crouchStart();
    else if(delta<-30) jump();
  }
  setTimeout(crouchEnd,200);
  touchStartY=null;
});

// ======================
// Старт игры
// ======================
restartGame();
</script>
</body>
</html>
