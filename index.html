<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>iVape Runner Online</title>
<style>
body { margin:0; overflow:hidden; font-family:Arial,sans-serif; }
canvas { display:block; background:#87CEEB; }
#gameOverUI { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
text-align:center; display:none; z-index:100; color:white; }
#retryBtn { padding:15px 25px; font-size:20px; margin-top:10px; background:#222; color:white;
border:none; border-radius:10px; cursor:pointer; }
#nameInputUI { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
text-align:center; z-index:100; color:white; }
#nameInput { padding:10px; font-size:18px; }
#submitName { padding:10px 20px; font-size:18px; margin-top:10px; cursor:pointer; }
#leaderboard { position:absolute; top:10px; left:10px; color:white; background:rgba(0,0,0,0.5);
padding:10px; border-radius:10px; max-width:200px; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="nameInputUI">
  <div>Введите имя:</div>
  <input type="text" id="nameInput" placeholder="Ваше имя">
  <br>
  <button id="submitName">Старт</button>
</div>

<div id="gameOverUI">
  <div>Хотите повторить попытку?</div>
  <button id="retryBtn">Да</button>
</div>

<div id="leaderboard"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, push, get, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

// ================= Firebase =================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ================= Игра =================
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const retryBtn=document.getElementById('retryBtn');
const gameOverUI=document.getElementById('gameOverUI');
const leaderboardDiv=document.getElementById('leaderboard');

function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
resizeCanvas(); window.addEventListener('resize',resizeCanvas);

// Игрок
let player={width:60,height:60,x:100,y:0,vy:0,gravity:0.6,jump:-15,
crouching:false,runFrames:[],frameIndex:0,frameSpeed:5,imgJump:new Image(),imgCrouch:new Image(),effectTimer:0};
for(let i=1;i<=2;i++){let img=new Image(); img.src="assets/images/player_run"+i+".png"; player.runFrames.push(img);}
player.imgJump.src="assets/images/player_jump.png";
player.imgCrouch.src="assets/images/player_crouch.png";

// Объекты
let obstacles=[], obstacleImages={ground:new Image(), air:new Image()};
obstacleImages.ground.src="assets/images/obstacle1.png";
obstacleImages.air.src="assets/images/obstacle2.png";

let bonuses=[], slows=[];
let bonusImg=new Image(); bonusImg.src="assets/images/bonus.png";
let slowImg=new Image(); slowImg.src="assets/images/slow.png";

let bgImg=new Image(); bgImg.src="assets/images/background.png";
let grassImg=new Image(); grassImg.src="assets/images/grass.png";

let groundY=0,bgX=0,grassX=0;
let speedMultiplier=1,invertedControl=false;
let frame=0,score=0,gameOver=false,gameRunning=false;

// Имя и ID
let playerName="";
let playerId = localStorage.getItem("playerId") || crypto.randomUUID();
localStorage.setItem("playerId", playerId);

// ====================== Создание объектов ======================
function createObstacle(){
  let o={x:canvas.width,width:60,height:60};
  o.type=Math.random()<0.7?"ground":"air";
  o.y=(o.type==="ground")?groundY-o.height:groundY-o.height-80;
  obstacles.push(o);
}

function createBonus(){
  let b={x:canvas.width,width:50,height:50};
  let safe=false;
  while(!safe){
    safe=true;
    b.y=groundY-b.height-10;
    obstacles.forEach(o=>{
      if(b.x<b.x+o.width && b.x+b.width>o.x && b.y<b.y+o. height && b.y+b.height>o.y) b.y=o.y-b.height-10;
    });
    [...bonuses,...slows].forEach(other=>{
      if(b.x<b.x+other.width && b.x+b.width>other.x && b.y<b.y+other.height && b.y+b.height>other.y) safe=false;
    });
  }
  bonuses.push(b);
}

function createSlow(){
  let s={x:canvas.width,width:50,height:50};
  let safe=false;
  while(!safe){
    safe=true;
    s.y=groundY-s.height-10;
    obstacles.forEach(o=>{
      if(s.x<s.x+o.width && s.x+s.width>o.x && s.y<s.y+o.height && s.y+s.height>o.y) s.y=o.y-s.height-10;
    });
    [...bonuses,...slows].forEach(other=>{
      if(s.x<s.x+other.width && s.x+s.width>other.x && s.y<s.y+other.height && s.y+s.height>other.y) safe=false;
    });
  }
  slows.push(s);
}

// ====================== Сброс игры ======================
function restartGame(){
  groundY = canvas.height*0.7;
  player.y = groundY-player.height; player.vy=0; player.crouching=false; player.effectTimer=0;
  obstacles=[]; bonuses=[]; slows=[];
  frame=0; score=0; gameOver=false;
  speedMultiplier=1; invertedControl=false;
  gameOverUI.style.display="none"; update();
  gameRunning=true;
}

// ====================== Отправка и получение рекордов ======================
async function sendScore(name, id, score){
  await push(ref(db,'scores'),{name,id,score});
  updateLeaderboard();
}

async function updateLeaderboard(){
  const q = query(ref(db,'scores'), orderByChild('score'), limitToLast(10));
  const snapshot = await get(q);
  let data = snapshot.val();
  if(!data) return;
  let arr = Object.values(data).sort((a,b)=>b.score-a.score);
  leaderboardDiv.innerHTML = "<b>Топ игроков:</b><br>"+arr.map(x=>x.name+": "+x.score).join("<br>");
}

// ====================== Основной цикл ======================
function update(){
  if(gameOver){ gameRunning=false; gameOverUI.style.display="block"; return; }
  frame++; ctx.clearRect(0,0,canvas.width,canvas.height);

  // Фон
  ctx.drawImage(bgImg,bgX,0,canvas.width,canvas.height);
  ctx.drawImage(bgImg,bgX+canvas.width,0,canvas.width,canvas.height);
  bgX-=1*speedMultiplier; if(bgX<=-canvas.width) bgX=0;

  // Земля
  if(grassImg.complete){
    grassX-=4*speedMultiplier; if(grassX<=-canvas.width) grassX=0;
    ctx.drawImage(grassImg,grassX,groundY,canvas.width,canvas.height-groundY);
    ctx.drawImage(grassImg,grassX+canvas.width,groundY,canvas.width,canvas.height-groundY);
  } else { ctx.fillStyle="#228B22"; ctx.fillRect(0,groundY,canvas.width,canvas.height-groundY); }

  // Создание объектов
  if(frame%100===0) createObstacle();
  if(frame%500===0) createBonus();
  if(frame%1000===0) createSlow();

  // Препятствия
  for(let i=obstacles.length-1;i>=0;i--){
    let o=obstacles[i]; o.x-=4*speedMultiplier;
    if(o.x+o.width<0){ obstacles.splice(i,1); score++; continue; }
    if(obstacleImages[o.type].complete) ctx.drawImage(obstacleImages[o.type],o.x,o.y,o.width,o.height);
    else ctx.fillStyle="brown"; ctx.fillRect(o.x,o.y,o.width,o.height);

    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<o.x+o.width-pad && player.x+player.width-pad>o.x+pad &&
       player.y+pad<o.y+o.height-pad && playerBottom-pad>o.y+pad){ gameOver=true; sendScore(playerName,playerId,score); }
  }

  // Бонусы
  let removeBonuses=[]; bonuses.forEach((b,i)=>{
    b.x-=4*speedMultiplier; if(b.x+b.width<0){ removeBonuses.push(i); return; }
    ctx.shadowBlur=10; ctx.shadowColor="lime";
    if(bonusImg.complete) ctx.drawImage(bonusImg,b.x,b.y,b.width,b.height);
    else ctx.fillStyle="green"; ctx.fillRect(b.x,b.y,b.width,b.height);
    ctx.shadowBlur=0;
    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<b.x+b.width-pad && player.x+player.width-pad>b.x+pad &&
       player.y+pad<b.y+b.height-pad && playerBottom-pad>b.y+pad){
      score+=5; speedMultiplier=1.5; player.effectTimer=30; removeBonuses.push(i);
      setTimeout(()=>speedMultiplier=1,5000);
    }
  });
  removeBonuses.reverse().forEach(i=>bonuses.splice(i,1));

  // Отрицательные бонусы
  let removeSlows=[]; slows.forEach((s,i)=>{
    s.x-=4*speedMultiplier; if(s.x+s.width<0){ removeSlows.push(i); return; }
    ctx.shadowBlur=10; ctx.shadowColor="red";
    if(slowImg.complete) ctx.drawImage(slowImg,s.x,s.y,s.width,s.height);
    else ctx.fillStyle="red"; ctx.fillRect(s.x,s.y,s.width,s.height);
    ctx.shadowBlur=0;
    let pad=5; let playerBottom=player.crouching?player.y+player.height/2:player.y+player.height;
    if(player.x+pad<s.x+s.width-pad && player.x+player.width-pad>s.x+pad &&
       player.y+pad<s.y+s.height-pad && playerBottom-pad>s.y+pad){
      score=Math.max(0,score-10); invertedControl=true; player.effectTimer=30; removeSlows.push(i);
      setTimeout(()=>invertedControl=false,5000);
    }
  });
  removeSlows.reverse().forEach(i=>slows.splice(i,1));

  // Игрок
  player.vy+=player.gravity; player.y+=player.vy;
  if(player.y>groundY-player.height){ player.y=groundY-player.height; player.vy=0; }
  let actualY=player.y; let drawHeight=player.height;
  if(player.crouching){ drawHeight=player.height/2; actualY+=player.height/2; }
  let imgToDraw;
  if(player.y<groundY-player.height) imgToDraw=player.imgJump;
  else if(player.crouching) imgToDraw=player.imgCrouch;
  else { if(frame%player.frameSpeed===0) player.frameIndex=(player.frameIndex+1)%player.runFrames.length;
         imgToDraw=player.runFrames[player.frameIndex]; }
  if(imgToDraw.complete) ctx.drawImage(imgToDraw,player.x,actualY,player.width,drawHeight);
  else ctx.fillStyle="blue"; ctx.fillRect(player.x,actualY,player.width,drawHeight);

  // Счёт
  ctx.fillStyle="rgba(0,0,0,0.5)"; ctx.fillRect(canvas.width-160,10,150,40);
  ctx.fillStyle="white"; ctx.font="bold 24px Arial"; ctx.fillText("Score: "+score,canvas.width-150,40);

  requestAnimationFrame(update);
}

// ====================== Управление ======================
function jump(){ if(!gameOver && player.y>=groundY-player.height-1) player.vy=player.jump; }
function crouchStart(){ if(!gameOver) player.crouching=true; }
function crouchEnd(){ player.crouching=false; }

document.addEventListener('keydown', e=>{
  if(invertedControl){ if(e.code==='Space'||e.code==='ArrowDown') jump(); if(e.code==='ArrowUp') crouchStart(); }
  else { if(e.code==='Space'||e.code==='ArrowUp') jump(); if(e.code==='ArrowDown') crouchStart(); }
});
document.addEventListener('keyup', e=>{ if(e.code==='ArrowDown'||e.code==='ArrowUp') crouchEnd(); });
document.addEventListener('click', jump);

// Сенсор
let touchStartY=null;
document.addEventListener('touchstart', e=>{ touchStartY=e.touches[0]?.clientY; });
document.addEventListener('touchend', e=>{
  if(!touchStartY) return; let touchEndY=e.changedTouches[0]?.clientY; if(!touchEndY) return;
  let delta=touchStartY-touchEndY;
  if(!invertedControl){ if(delta>30) jump(); else if(delta<-30) crouchStart(); }
  else { if(delta>30) crouchStart(); else if(delta<-30) jump(); }
  setTimeout(crouchEnd,200); touchStartY=null;
});

// ====================== Кнопки ======================
retryBtn.addEventListener('click',()=>{ restartGame(); });

document.getElementById('submitName').addEventListener('click',()=>{
  let input=document.getElementById('nameInput').value.trim();
  if(input){ playerName=input; document.getElementById('nameInputUI').style.display="none"; restartGame(); updateLeaderboard(); }
});
</script>
</body>
</html>
